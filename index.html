<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Geolocation SPY</title>
  <!-- Mapbox GL JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- EXIF JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    body {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
    }
    #app-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #streetview-container {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 20;
    }
    #streetview {
      width: 100%;
      height: 100%;
      border: none;
    }
    #info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 300px;
      background-color: rgba(18,18,18,0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
    }
    #search-container {
      display: flex;
      align-items: center;
      background-color: #242424;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 20px;
    }
    #search-container svg {
      margin-right: 8px;
      opacity: 0.7;
    }
    #search-input {
      background: none;
      border: none;
      color: #fff;
      outline: none;
      width: 100%;
      font-size: 14px;
    }
    #image-preview {
      width: 100%;
      aspect-ratio: 1/1;
      background-color: #242424;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }
    #image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(36,36,36,0.8);
      cursor: pointer;
    }
    #upload-overlay.hidden {
      display: none;
    }
    #upload-icon {
      margin-bottom: 10px;
      opacity: 0.7;
    }
    #upload-text {
      color: #fff;
      font-size: 14px;
      text-align: center;
    }
    .location-info {
      margin-bottom: 15px;
    }
    .location-label {
      color: #999;
      font-size: 12px;
      margin-bottom: 3px;
    }
    .location-value {
      color: #fff;
      font-size: 14px;
      margin-bottom: 10px;
      font-weight: 500;
    }
    #action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }
    .action-btn {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #242424;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .action-btn:hover {
      background-color: #333;
    }
    .enterprise-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(0,0,0,0.5);
      border-radius: 4px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      z-index: 200;
    }
    .enterprise-text {
      margin-right: 10px;
    }
    .enterprise-badge .title {
      font-size: 14px;
      font-weight: 500;
    }
    .enterprise-badge .subtitle {
      font-size: 12px;
      color: #ccc;
    }
    .badge-link {
      display: flex;
      align-items: center;
      color: white;
      text-decoration: none;
    }
    .floating-info {
      position: absolute;
      background-color: rgba(0,0,0,0.7);
      border-radius: 6px;
      padding: 10px 12px;
      z-index: 200;
      color: white;
      font-size: 13px;
    }
    #location-name {
      top: 20px;
      left: 340px;
    }
    #location-name .title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    #location-name .subtitle {
      display: none;
    }
    #neighborhood-info {
      position: absolute;
      bottom: 30px;
      left: 20px;
      background-color: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #ccc;
      z-index: 999;
    }
    .attribution {
      display: none;
    }
    .mapboxgl-canvas {
      outline: none;
    }
    .mapboxgl-ctrl-logo {
      display: none !important;
    }
    #file-input {
      display: none;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="map"></div>
    <div id="streetview-container">
      <iframe id="streetview"></iframe>
    </div>
    <div id="info-panel">
      <div id="search-container">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="search-input" placeholder="New search" />
      </div>
      <div id="image-preview">
        <img id="preview-img" src="" style="display: none;" />
        <div id="upload-overlay">
          <svg id="upload-icon" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <p id="upload-text">Click to upload an image</p>
        </div>
      </div>
      <div class="location-info">
        <div class="location-label">Detail</div>
        <div class="location-value" id="detail-value">unknown</div>
        <div class="location-label">Negara</div>
        <div class="location-value" id="country-value">unknown</div>
        <div class="location-label">Kota</div>
        <div class="location-value" id="city-value">unknown</div>
        <div class="location-label">Kordinator</div>
        <div class="location-value" id="coord-value">unknown</div>
      </div>
      <div id="action-buttons">
        <div class="action-btn" id="map-btn">Map</div>
        <div class="action-btn" id="share-geospy">Street View</div>
      </div>
    </div>
    <div class="enterprise-badge">
      <div class="enterprise-text">
        <div class="title">Enterprise?</div>
        <div class="subtitle">Partner with us</div>
      </div>
      <a href="#" class="badge-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </a>
    </div>
    <div class="floating-info" id="location-name">
      <div class="title">Geolocation SPY</div>
    </div>
    <div id="neighborhood-info">sweet geolocation</div>
  </div>
  <input type="file" id="file-input" accept="image/*" />
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <script>
    const MAPBOX_TOKEN = "pk.eyJ1IjoiYXZpb3BvcnRvbGFubyIsImEiOiJja212cmRrd2QwN3dzMnZuMXV2d25xbWsxIn0.x3y36v9arY9wmBOCZlCXUA";
    const GEMINI_API_KEY = "AIzaSyBnAFtB1TcTzpkJ1CwxgjSurhhUSVOo9HI"; // Replace with your actual Gemini API key
    mapboxgl.accessToken = MAPBOX_TOKEN;

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/dark-v11",
      center: [0, 0],
      zoom: 2,
      pitch: 0,
    });

    let trackingMarker = null;
    let lastMatchedCoord = { lat: 0, lng: 0 };

    const fileInput = document.getElementById("file-input");
    const previewImg = document.getElementById("preview-img");
    const uploadOverlay = document.getElementById("upload-overlay");
    const loadingOverlay = document.getElementById("loading-overlay");

    function imageToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function analyzePhotoWithGemini(photoBlob) {
      try {
        const base64Image = await imageToBase64(photoBlob);
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: `Analyze this image with high precision to determine its geolocation. Provide the following in JSON format:
                      - latitude (float, precise to 6 decimal places)
                      - longitude (float, precise to 6 decimal places)
                      - city (string, most specific possible)
                      - country (string)
                      - description (string, one-sentence summary of the location, e.g., "Near Eiffel Tower in Paris")
                      Use visual clues like landmarks, street signs, architectural styles, license plates, or text to ensure accurate coordinates. If coordinates are uncertain, estimate based on contextual evidence and note confidence level in the description (e.g., "Low confidence estimate"). Ensure all fields are filled; use "unknown" if data is unavailable.`
                    },
                    {
                      inlineData: {
                        mimeType: photoBlob.type,
                        data: base64Image,
                      },
                    },
                  ],
                },
              ],
            }),
          }
        );

        if (!response.ok) {
          throw new Error(`Gemini API error: ${response.statusText}`);
        }

        const data = await response.json();
        let resultText = data.candidates[0].content.parts[0].text;

        // Clean Markdown code blocks
        resultText = resultText.replace(/```json\n|\n```/g, '').trim();

        // Parse the cleaned JSON
        let locationData;
        try {
          locationData = JSON.parse(resultText);
        } catch (parseError) {
          console.error("Failed to parse Gemini response as JSON:", parseError);
          throw new Error("Invalid JSON response from Gemini API");
        }

        // Validate required fields
        if (!locationData.latitude || !locationData.longitude) {
          throw new Error("Missing latitude or longitude in Gemini response");
        }

        // Validate coordinates against reverse geocoding
        const geocodedInfo = await reverseGeocode(locationData.latitude, locationData.longitude);
        if (geocodedInfo.city !== "unknown" && locationData.city !== geocodedInfo.city) {
          locationData.description += " (Coordinates may be imprecise; verified city: " + geocodedInfo.city + ")";
        }

        return {
          lat: parseFloat(locationData.latitude) || 0,
          lng: parseFloat(locationData.longitude) || 0,
          city: locationData.city || "unknown",
          country: locationData.country || "unknown",
          description: locationData.description || "unknown",
        };
      } catch (error) {
        console.error("Error analyzing photo with Gemini:", error);
        alert("Failed to analyze image with Gemini API. Using default location.");
        return {
          lat: 0,
          lng: 0,
          city: "unknown",
          country: "unknown",
          description: "unknown",
        };
      }
    }

    async function reverseGeocode(lat, lng) {
      try {
        const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}`;
        const res = await fetch(endpoint);
        const data = await res.json();
        let detail = "unknown", country = "unknown", city = "unknown";
        if (data.features && data.features.length > 0) {
          detail = data.features[0].place_name || "unknown";
          data.features.forEach(f => {
            if (f.place_type.includes("country")) country = f.text;
            if (f.place_type.includes("place")) city = f.text;
          });
        }
        return { detail, country, city };
      } catch (error) {
        console.error("Error in reverse geocoding:", error);
        return { detail: "unknown", country: "unknown", city: "unknown" };
      }
    }

    document.getElementById("image-preview").addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      loadingOverlay.style.display = "flex";

      const reader = new FileReader();
      reader.onload = async (evt) => {
        const imageData = evt.target.result;
        previewImg.src = imageData;
        previewImg.style.display = "block";
        uploadOverlay.classList.add("hidden");

        // Check EXIF for GPS data
        let exifLat = 0, exifLng = 0;
        EXIF.getData(file, async function() {
          const gpsLat = EXIF.getTag(this, "GPSLatitude");
          const gpsLng = EXIF.getTag(this, "GPSLongitude");
          const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
          const lngRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

          if (gpsLat && gpsLng) {
            const lat = gpsLat[0] + gpsLat[1]/60 + gpsLat[2]/3600;
            const lng = gpsLng[0] + gpsLng[1]/60 + gpsLng[2]/3600;
            exifLat = latRef === "N" ? lat : -lat;
            exifLng = lngRef === "E" ? lng : -lng;
          }

          // Analyze with Gemini if no EXIF GPS
          const locationData = exifLat && exifLng ? 
            { lat: exifLat, lng: exifLng, city: "unknown", country: "unknown", description: "From EXIF data" } : 
            await analyzePhotoWithGemini(file);
          lastMatchedCoord = { lat: locationData.lat, lng: locationData.lng };

          let info = {
            detail: locationData.description,
            country: locationData.country,
            city: locationData.city,
          };

          // Fallback to reverse geocoding if needed
          if (info.detail === "unknown" || info.country === "unknown" || info.city === "unknown") {
            const geocodedInfo = await reverseGeocode(locationData.lat, locationData.lng);
            info = {
              detail: info.detail !== "unknown" ? info.detail : geocodedInfo.detail,
              country: info.country !== "unknown" ? info.country : geocodedInfo.country,
              city: info.city !== "unknown" ? info.city : geocodedInfo.city,
            };
          }

          document.getElementById("detail-value").textContent = info.detail;
          document.getElementById("country-value").textContent = info.country;
          document.getElementById("city-value").textContent = info.city;
          document.getElementById("coord-value").textContent =
            locationData.lat.toFixed(6) + ", " + locationData.lng.toFixed(6);

          if (trackingMarker) trackingMarker.remove();
          const markerEl = document.createElement("img");
          markerEl.src = imageData;
          markerEl.style.width = "60px";
          markerEl.style.height = "60px";
          markerEl.style.borderRadius = "50%";
          markerEl.style.border = "2px solid white";
          trackingMarker = new mapboxgl.Marker(markerEl)
            .setLngLat([locationData.lng, locationData.lat])
            .addTo(map);
          map.flyTo({
            center: [locationData.lng, locationData.lat],
            zoom: 14,
            essential: true,
          });

          loadingOverlay.style.display = "none";
        });
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("map-btn").addEventListener("click", () => {
      document.getElementById("streetview-container").style.display = "none";
      document.getElementById("map").style.display = "block";
    });

    document.getElementById("share-geospy").addEventListener("click", () => {
      const lat = lastMatchedCoord.lat;
      const lng = lastMatchedCoord.lng;
      const streetViewUrl = `https://www.google.com/maps/embed?pb=!4v0!6m8!1m7!1sCAoSLEFGMVFpcE1pVUlONllYeXpHdXVpUjd4cjlHcWxGQVZ2cnlyT1I5NmFwTE9B!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469`;
      document.getElementById("streetview").src = streetViewUrl;
      document.getElementById("streetview-container").style.display = "block";
      document.getElementById("map").style.display = "none";
    });

    document.querySelector(".badge-link").addEventListener("click", () => {
      alert("Enterprise link clicked!");
    });
  </script>
</body>
</html>
