<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Geolocation SPY</title>
  <!-- Mapbox GL JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- EXIF JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    body {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
    }
    #app-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #streetview-container {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 20;
    }
    #streetview {
      width: 100%;
      height: 100%;
      border: none;
    }
    #info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 300px;
      background-color: rgba(18,18,18,0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
    }
    #search-container {
      display: flex;
      align-items: center;
      background-color: #242424;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 20px;
    }
    #search-container svg {
      margin-right: 8px;
      opacity: 0.7;
    }
    #search-input {
      background: none;
      border: none;
      color: #fff;
      outline: none;
      width: 100%;
      font-size: 14px;
    }
    #image-preview {
      width: 100%;
      aspect-ratio: 1/1;
      background-color: #242424;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }
    #image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(36,36,36,0.8);
      cursor: pointer;
    }
    #upload-overlay.hidden {
      display: none;
    }
    #upload-icon {
      margin-bottom: 10px;
      opacity: 0.7;
    }
    #upload-text {
      color: #fff;
      font-size: 14px;
      text-align: center;
    }
    .location-info {
      margin-bottom: 15px;
    }
    .location-label {
      color: #999;
      font-size: 12px;
      margin-bottom: 3px;
    }
    .location-value {
      color: #fff;
      font-size: 14px;
      margin-bottom: 10px;
      font-weight: 500;
    }
    #action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }
    .action-btn {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #242424;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .action-btn:hover {
      background-color: #333;
    }
    .enterprise-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(0,0,0,0.5);
      border-radius: 4px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      z-index: 200;
    }
    .enterprise-text {
      margin-right: 10px;
    }
    .enterprise-badge .title {
      font-size: 14px;
      font-weight: 500;
    }
    .enterprise-badge .subtitle {
      font-size: 12px;
      color: #ccc;
    }
    .badge-link {
      display: flex;
      align-items: center;
      color: white;
      text-decoration: none;
    }
    .floating-info {
      position: absolute;
      background-color: rgba(0,0,0,0.7);
      border-radius: 6px;
      padding: 10px 12px;
      z-index: 200;
      color: white;
      font-size: 13px;
    }
    #location-name {
      top: 20px;
      left: 340px;
    }
    #location-name .title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    #location-name .subtitle {
      display: none;
    }
    #neighborhood-info {
      position: absolute;
      bottom: 30px;
      left: 20px;
      background-color: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #ccc;
      z-index: 999;
    }
    .attribution {
      display: none;
    }
    .mapboxgl-canvas {
      outline: none;
    }
    .mapboxgl-ctrl-logo {
      display: none !important;
    }
    #file-input {
      display: none;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="map"></div>
    <div id="streetview-container">
      <iframe id="streetview"></iframe>
    </div>
    <div id="info-panel">
      <div id="search-container">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="search-input" placeholder="New search" />
      </div>
      <div id="image-preview">
        <img id="preview-img" src="" style="display: none;" />
        <div id="upload-overlay">
          <svg id="upload-icon" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <p id="upload-text">Click to upload an image</p>
        </div>
      </div>
      <div class="location-info">
        <div class="location-label">Detail</div>
        <div class="location-value" id="detail-value">unknown</div>
        <div class="location-label">Negara</div>
        <div class="location-value" id="country-value">unknown</div>
        <div class="location-label">Kota</div>
        <div class="location-value" id="city-value">unknown</div>
        <div class="location-label">Kordinator</div>
        <div class="location-value" id="coord-value">unknown</div>
      </div>
      <div id="action-buttons">
        <div class="action-btn" id="map-btn">Map</div>
        <div class="action-btn" id="share-geospy">Street View</div>
      </div>
    </div>
    <div class="enterprise-badge">
      <div class="enterprise-text">
        <div class="title">Enterprise?</div>
        <div class="subtitle">Partner with us</div>
      </div>
      <a href="#" class="badge-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </a>
    </div>
    <div class="floating-info" id="location-name">
      <div class="title">Geolocation SPY</div>
    </div>
    <div id="neighborhood-info">sweet geolocation</div>
  </div>
  <input type="file" id="file-input" accept="image/*" />
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <script>
    const MAPBOX_TOKEN = "pk.eyJ1IjoiYXZpb3BvcnRvbGFubyIsImEiOiJja212cmRrd2QwN3dzMnZuMXV2d25xbWsxIn0.x3y36v9arY9wmBOCZlCXUA";
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const SERVER_URL = "http://localhost:5000"; // Ganti dengan URL server Railway setelah deploy

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/dark-v11",
      center: [0, 0],
      zoom: 2,
      pitch: 0,
    });

    let trackingMarker = null;
    let lastMatchedCoord = { lat: 0, lng: 0 };

    const fileInput = document.getElementById("file-input");
    const previewImg = document.getElementById("preview-img");
    const uploadOverlay = document.getElementById("upload-overlay");
    const loadingOverlay = document.getElementById("loading-overlay");

    async function predictLocation(file) {
      try {
        const formData = new FormData();
        formData.append("photo", file);
        const response = await fetch(`${SERVER_URL}/predict`, {
          method: "POST",
          body: formData,
        });
        if (!response.ok) throw new Error("Gagal memproses gambar");
        const data = await response.json();
        return {
          lat: data.latitude || 0,
          lng: data.longitude || 0,
          score: data.score || 0,
        };
      } catch (error) {
        console.error("Error memprediksi lokasi:", error);
        alert("Gagal memprediksi lokasi. Menggunakan lokasi default.");
        return { lat: 0, lng: 0, score: 0 };
      }
    }

    async function reverseGeocode(lat, lng) {
      try {
        const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}`;
        const res = await fetch(endpoint);
        const data = await res.json();
        let detail = "unknown", country = "unknown", city = "unknown";
        if (data.features && data.features.length > 0) {
          detail = data.features[0].place_name || "unknown";
          data.features.forEach(f => {
            if (f.place_type.includes("country")) country = f.text;
            if (f.place_type.includes("place")) city = f.text;
          });
        }
        return { detail, country, city };
      } catch (error) {
        console.error("Error reverse geocoding:", error);
        return { detail: "unknown", country: "unknown", city: "unknown" };
      }
    }

    document.getElementById("image-preview").addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      loadingOverlay.style.display = "flex";

      const reader = new FileReader();
      reader.onload = async (evt) => {
        const imageData = evt.target.result;
        previewImg.src = imageData;
        previewImg.style.display = "block";
        uploadOverlay.classList.add("hidden");

        const locationData = await predictLocation(file);
        lastMatchedCoord = { lat: locationData.lat, lng: locationData.lng };

        const geocodedInfo = await reverseGeocode(locationData.lat, locationData.lng);
        const info = {
          detail: geocodedInfo.detail,
          country: geocodedInfo.country,
          city: geocodedInfo.city,
        };

        document.getElementById("detail-value").textContent = info.detail;
        document.getElementById("country-value").textContent = info.country;
        document.getElementById("city-value").textContent = info.city;
        document.getElementById("coord-value").textContent =
          locationData.lat.toFixed(5) + ", " + locationData.lng.toFixed(5);

        if (trackingMarker) trackingMarker.remove();
        const markerEl = document.createElement("img");
        markerEl.src = imageData;
        markerEl.style.width = "60px";
        markerEl.style.height = "60px";
        markerEl.style.borderRadius = "50%";
        markerEl.style.border = "2px solid white";
        trackingMarker = new mapboxgl.Marker(markerEl)
          .setLngLat([locationData.lng, locationData.lat])
          .addTo(map);
        map.flyTo({
          center: [locationData.lng, locationData.lat],
          zoom: 14,
          essential: true,
        });

        loadingOverlay.style.display = "none";
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("map-btn").addEventListener("click", () => {
      document.getElementById("streetview-container").style.display = "none";
      document.getElementById("map").style.display = "block";
    });

    document.getElementById("share-geospy").addEventListener("click", () => {
      const lat = lastMatchedCoord.lat;
      const lng = lastMatchedCoord.lng;
      const streetViewUrl = `https://www.google.com/maps/embed?pb=!4v0!6m8!1m7!1sCAoSLEFGMVFpcE1pVUlONllYeXpHdXVpUjd4cjlHcWxGQVZ2cnlyT1I5NmFwTE9B!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469`;
      document.getElementById("streetview").src = streetViewUrl;
      document.getElementById("streetview-container").style.display = "block";
      document.getElementById("map").style.display = "none";
    });

    document.querySelector(".badge-link").addEventListener("click", () => {
      alert("Enterprise link diklik!");
    });
  </script>
</body>
</html>
