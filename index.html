<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geolocation SPY</title>
  <!-- Favicon for Google Search Results -->
<link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/50/ffffff/spy.png">
  <!-- Mapbox GL JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- EXIF JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    body {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
    }
    #app-container {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    #streetview-container {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 20;
    }
    #streetview {
      width: 100%;
      height: 100%;
      border: none;
    }
    #info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 300px;
      background-color: rgba(18,18,18,0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
    }
    #geolocation-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 250px;
      background-color: rgba(18,18,18,0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
      background-image: url('https://img.icons8.com/ios/50/ffffff/spy.png');
      background-size: 50px;
      background-position: top right;
      background-repeat: no-repeat;
    }
    #search-container, #city-search-container {
      display: flex;
      align-items: center;
      background-color: #242424;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 20px;
    }
    #search-container svg, #city-search-container svg {
      margin-right: 8px;
      opacity: 0.7;
    }
    #search-input, #city-search-input {
      background: none;
      border: none;
      color: #fff;
      outline: none;
      width: 100%;
      font-size: 14px;
    }
    #image-preview {
      width: 100%;
      aspect-ratio: 1/1;
      background-color: #242424;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }
    #image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(36,36,36,0.8);
      cursor: pointer;
    }
    #upload-overlay.hidden {
      display: none;
    }
    #upload-icon {
      margin-bottom: 10px;
      opacity: 0.7;
    }
    #upload-text {
      color: #fff;
      font-size: 14px;
      text-align: center;
    }
    .location-info, .city-info {
      margin-bottom: 15px;
    }
    .location-label, .city-label {
      color: #999;
      font-size: 12px;
      margin-bottom: 3px;
    }
    .location-value, .city-value {
      color: #fff;
      font-size: 14px;
      margin-bottom: 10px;
      font-weight: 500;
    }
    #action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }
    .action-btn {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #242424;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .action-btn:hover {
      background-color: #333;
    }
    .floating-info {
      position: absolute;
      background-color: rgba(0,0,0,0.7);
      border-radius: 6px;
      padding: 10px 12px;
      z-index: 200;
      color: white;
      font-size: 13px;
    }
    #location-name {
      top: 20px;
      left: 340px;
    }
    #location-name .title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    #neighborhood-info {
      position: absolute;
      bottom: 30px;
      left: 20px;
      background-color: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #ccc;
      z-index: 999;
    }
    .attribution {
      display: none;
    }
    .mapboxgl-canvas {
      outline: none;
    }
    .mapboxgl-ctrl-logo {
      display: none !important;
    }
    #file-input {
      display: none;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    #analysis-results {
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="map"></div>
    <div id="streetview-container">
      <iframe id="streetview"></iframe>
    </div>
    <div id="info-panel">
      <div id="search-container">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="search-input" placeholder="New search" />
      </div>
      <div id="image-preview">
        <img id="preview-img" src="" style="display: none;" />
        <div id="upload-overlay">
          <svg id="upload-icon" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <p id="upload-text">Click to upload an image</p>
        </div>
      </div>
      <div class="location-info">
        <div class="location-label">Detail</div>
        <div class="location-value" id="detail-value">unknown</div>
        <div class="location-label">Negara</div>
        <div class="location-value" id="country-value">unknown</div>
        <div class="location-label">Kota</div>
        <div class="location-value" id="city-value">unknown</div>
        <div class="location-label">Kordinator</div>
        <div class="location-value" id="coord-value">unknown</div>
        <div class="location-label">Analisis</div>
        <div id="analysis-results">No analysis available</div>
      </div>
      <div id="action-buttons">
        <div class="action-btn" id="map-btn">Map</div>
        <div class="action-btn" id="share-geospy">Street View</div>
      </div>
    </div>
    <div id="geolocation-panel">
      <div id="city-search-container">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <input type="text" id="city-search-input" placeholder="Select city for AI focus" />
      </div>
      <div class="city-info">
        <div class="city-label">Selected City</div>
        <div class="city-value" id="selected-city">None</div>
      </div>
    </div>
    <div class="floating-info" id="location-name">
      <div class="title">Geolocation SPY</div>
    </div>
    <div id="neighborhood-info">sweet geolocation</div>
  </div>
  <input type="file" id="file-input" accept="image/*" />
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <script>
    const MAPBOX_TOKEN = "pk.eyJ1IjoiYXZpb3BvcnRvbGFubyIsImEiOiJja212cmRrd2QwN3dzMnZuMXV2d25xbWsxIn0.x3y36v9arY9wmBOCZlCXUA";
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const GEMINI_API_KEY = "AIzaSyBnAFtB1TcTzpkJ1CwxgjSurhhUSVOo9HI"; // Replace with your actual Gemini API key

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/dark-v10",
      center: [0, 0],
      zoom: 2,
      pitch: 0,
    });

    let trackingMarker = null;
    let lastMatchedCoord = { lat: 0, lng: 0 };
    let selectedCity = null;

    const fileInput = document.getElementById("file-input");
    const previewImg = document.getElementById("preview-img");
    const uploadOverlay = document.getElementById("upload-overlay");
    const loadingOverlay = document.getElementById("loading-overlay");
    const citySearchInput = document.getElementById("city-search-input");
    const selectedCityDisplay = document.getElementById("selected-city");
    const analysisResults = document.getElementById("analysis-results");

    // Image Analysis Module
    const ImageAnalyzer = {
      analyzeElements(data) {
        const elements = {
          trees: data.trees || { count: 0, types: [] },
          buildings: data.buildings || { count: 0, types: [] },
          landmarks: data.landmarks || { count: 0, names: [] },
          roads: data.roads || { count: 0, types: [] },
          other: data.other || []
        };
        return `
          <b>Trees:</b> ${elements.trees.count} (${elements.trees.types.join(", ") || "none"})<br>
          <b>Buildings:</b> ${elements.buildings.count} (${elements.buildings.types.join(", ") || "none"})<br>
          <b>Landmarks:</b> ${elements.landmarks.count} (${elements.landmarks.names.join(", ") || "none"})<br>
          <b>Roads:</b> ${elements.roads.count} (${elements.roads.types.join(", ") || "none"})<br>
          <b>Other:</b> ${elements.other.join(", ") || "none"}
        `;
      }
    };

    function imageToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function analyzePhotoWithGemini(photoBlob) {
      try {
        const base64Image = await imageToBase64(photoBlob);
        const cityContext = selectedCity ? `Focus analysis on ${selectedCity} for higher accuracy.` : "";
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: `${cityContext} Analyze this image with high precision to provide accurate location information and a comprehensive analysis of elements present. Return the response in JSON format with the following fields:
                      - latitude: The latitude of the location (numeric, precise to at least 6 decimal places).
                      - longitude: The longitude of the location (numeric, precise to at least 6 decimal places).
                      - city: The city name.
                      - country: The country name.
                      - description: A detailed description of the location, including notable features.
                      - analysis: An object containing:
                        - trees: { count: number, types: array of strings }
                        - buildings: { count: number, types: array of strings }
                        - landmarks: { count: number, names: array of strings }
                        - roads: { count: number, types: array of strings }
                        - other: array of strings for other notable elements
                      Prioritize precise coordinates by cross-referencing visual cues (landmarks, signage, architecture) with known geographic data. Ensure the analysis includes identification of trees (type, count), buildings (type, count), landmarks (name, count), roads (type, count), and any other notable features like vehicles, signs, or natural elements.`
                    },
                    {
                      inlineData: {
                        mimeType: photoBlob.type,
                        data: base64Image,
                      },
                    },
                  ],
                },
              ],
            }),
          }
        );

        if (!response.ok) {
          throw new Error(`Gemini API error: ${response.statusText}`);
        }

        const data = await response.json();
        let resultText = data.candidates[0].content.parts[0].text;

        // Clean Markdown code blocks
        resultText = resultText.replace(/```json\n|\n```/g, '').trim();

        // Parse the cleaned JSON
        let locationData;
        try {
          locationData = JSON.parse(resultText);
        } catch (parseError) {
          console.error("Failed to parse Gemini response as JSON:", parseError);
          throw new Error("Invalid JSON response from Gemini API");
        }

        // Validate required fields and coordinate precision
        if (!locationData.latitude || !locationData.longitude || isNaN(locationData.latitude) || isNaN(locationData.longitude)) {
          throw new Error("Missing or invalid latitude/longitude in Gemini response");
        }

        // Ensure coordinates are numeric and precise
        const lat = parseFloat(locationData.latitude.toFixed(6));
        const lng = parseFloat(locationData.longitude.toFixed(6));

        return {
          lat,
          lng,
          city: locationData.city || "unknown",
          country: locationData.country || "unknown",
          description: locationData.description || "unknown",
          analysis: locationData.analysis || {}
        };
      } catch (error) {
        console.error("Error analyzing photo with Gemini:", error);
        alert("Failed to analyze image with Gemini API. Using default location.");
        return {
          lat: 0,
          lng: 0,
          city: "unknown",
          country: "unknown",
          description: "unknown",
          analysis: {}
        };
      }
    }

    async function reverseGeocode(lat, lng) {
      try {
        const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}`;
        const res = await fetch(endpoint);
        const data = await res.json();
        let detail = "unknown", country = "unknown", city = "unknown";
        if (data.features && data.features.length > 0) {
          detail = data.features[0].place_name || "unknown";
          data.features.forEach(f => {
            if (f.place_type.includes("country")) country = f.text;
            if (f.place_type.includes("place")) city = f.text;
          });
        }
        return { detail, country, city };
      } catch (error) {
        console.error("Error in reverse geocoding:", error);
        return { detail: "unknown", country: "unknown", city: "unknown" };
      }
    }

    async function searchCity(query) {
      try {
        const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&types=place`;
        const res = await fetch(endpoint);
        const data = await res.json();
        if (data.features && data.features.length > 0) {
          const city = data.features[0].text;
          selectedCity = city;
          selectedCityDisplay.textContent = city;
          return city;
        }
        return null;
      } catch (error) {
        console.error("Error searching city:", error);
        return null;
      }
    }

    document.getElementById("image-preview").addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      loadingOverlay.style.display = "flex";

      const reader = new FileReader();
      reader.onload = async (evt) => {
        const imageData = evt.target.result;
        previewImg.src = imageData;
        previewImg.style.display = "block";
        uploadOverlay.classList.add("hidden");

        const locationData = await analyzePhotoWithGemini(file);
        lastMatchedCoord = { lat: locationData.lat, lng: locationData.lng };

        // Cross-reference with reverse geocoding for validation
        let info = {
          detail: locationData.description,
          country: locationData.country,
          city: locationData.city,
        };

        if (info.detail === "unknown" || info.country === "unknown" || info.city === "unknown" || Math.abs(locationData.lat) < 0.0001 && Math.abs(locationData.lng) < 0.0001) {
          const geocodedInfo = await reverseGeocode(locationData.lat, locationData.lng);
          info = {
            detail: info.detail !== "unknown" ? info.detail : geocodedInfo.detail,
            country: info.country !== "unknown" ? info.country : geocodedInfo.country,
            city: info.city !== "unknown" ? info.city : geocodedInfo.city,
          };
        }

        document.getElementById("detail-value").textContent = info.detail;
        document.getElementById("country-value").textContent = info.country;
        document.getElementById("city-value").textContent = info.city;
        document.getElementById("coord-value").textContent =
          locationData.lat.toFixed(6) + ", " + locationData.lng.toFixed(6);
        analysisResults.innerHTML = ImageAnalyzer.analyzeElements(locationData.analysis);

        if (trackingMarker) trackingMarker.remove();
        const markerEl = document.createElement("img");
        markerEl.src = imageData;
        markerEl.style.width = "60px";
        markerEl.style.height = "60px";
        markerEl.style.borderRadius = "50%";
        markerEl.style.border = "2px solid white";
        trackingMarker = new mapboxgl.Marker(markerEl)
          .setLngLat([locationData.lng, locationData.lat])
          .addTo(map);
        map.flyTo({
          center: [locationData.lng, locationData.lat],
          zoom: 14,
          essential: true,
        });

        loadingOverlay.style.display = "none";
      };
      reader.readAsDataURL(file);
    });

    citySearchInput.addEventListener("change", async (e) => {
      const query = e.target.value.trim();
      if (query) {
        const city = await searchCity(query);
        if (city) {
          alert(`AI focus set to ${city} for enhanced accuracy.`);
        } else {
          alert("City not found.");
        }
      }
    });

    document.getElementById("map-btn").addEventListener("click", () => {
      document.getElementById("streetview-container").style.display = "none";
      document.getElementById("map").style.display = "block";
    });

    document.getElementById("share-geospy").addEventListener("click", () => {
      const lat = lastMatchedCoord.lat;
      const lng = lastMatchedCoord.lng;
      const streetViewUrl = `https://www.google.com/maps/embed?pb=!4v0!6m8!1m7!1sCAoSLEFGMVFpcE1pVUlONllYeXpHdXVpUjd4cjlHcWxGQVZ2cnlyT1I5NmFwTE9B!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469`;
      document.getElementById("streetview").src = streetViewUrl;
      document.getElementById("streetview-container").style.display = "block";
      document.getElementById("map").style.display = "none";
    });
  </script>
</body>
</html>
