<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Foto Geotag Super Akurat</title>
  <!-- Bootstrap Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet" />
  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- localForage untuk penyimpanan modern -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
      background: #fff;
    }
    body.dark {
      background: #1a1a1a;
    }
    .top-bar {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .add-button, .menu-button, .accurate-button {
      width: 36px;
      height: 36px;
      background: black;
      border: none;
      border-radius: 8px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 2000;
    }
    body.dark .add-button, body.dark .menu-button, body.dark .accurate-button {
      background: #333;
      color: #fff;
    }
    .loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 3000;
    }
    .loading-indicator.show {
      display: block;
    }
    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-top: 4px solid #000;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    body.dark .spinner {
      border: 4px solid rgba(255,255,255,0.1);
      border-top: 4px solid #fff;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .info-panel {
      position: absolute;
      background: rgba(230, 240, 250, 0.8);
      border-radius: 12px;
      z-index: 1000;
      width: 220px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      opacity: 0;
      transition: opacity 0.3s ease;
      transform-origin: top left;
    }
    body.dark .info-panel {
      background: rgba(40, 40, 40, 0.8);
      box-shadow: 0 4px 12px rgba(255,255,255,0.1);
    }
    .info-panel.show {
      opacity: 1;
    }
    .location-preview {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    .location-image {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      overflow: hidden;
      background: #f5f5f5;
      flex-shrink: 0;
    }
    body.dark .location-image {
      background: #333;
    }
    .location-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .location-info {
      flex-grow: 1;
    }
    .location-info-item {
      margin-bottom: 6px;
    }
    .location-info-label {
      font-size: 10px;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
    }
    body.dark .location-info-label {
      color: #aaa;
    }
    .location-info-value {
      font-size: 12px;
      color: #333;
      font-weight: 600;
      text-transform: uppercase;
    }
    body.dark .location-info-value {
      color: #fff;
    }
    .location-coordinates {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .location-explanation-label {
      font-size: 10px;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    body.dark .location-explanation-label {
      color: #aaa;
    }
    .location-explanation {
      font-size: 11px;
      color: #333;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    body.dark .location-explanation {
      color: #ddd;
    }
    .button-container {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }
    .maps-button, .street-view-button {
      background: #000;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px;
      font-size: 12px;
      font-weight: 500;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-transform: uppercase;
    }
    body.dark .maps-button, body.dark .street-view-button {
      background: #333;
    }
    .export-button {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      font-size: 12px;
      font-weight: 500;
      width: 100%;
      margin-bottom: 0;
      cursor: pointer;
      text-align: center;
      text-transform: uppercase;
    }
    body.dark .export-button {
      background: #333;
      color: #fff;
      border: 1px solid #555;
    }
    #map {
      width: 100%;
      height: 100%;
      background: #f8f9fa;
    }
    body.dark #map {
      background: #222;
    }
    #streetviewContainer {
      width: 100%;
      height: 100%;
      display: none;
    }
    #streetviewIframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .file-input {
      display: none;
    }
    .location-marker {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      overflow: hidden;
      cursor: pointer;
      position: absolute;
      transform: translate(-50%, -100%);
      transform-origin: center bottom;
    }
    body.dark .location-marker {
      border: 2px solid #ddd;
      box-shadow: 0 2px 8px rgba(255,255,255,0.2);
    }
    .location-marker img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .accurate-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 1500;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 30px;
      transition: opacity 0.3s ease;
    }
    body.dark .accurate-panel {
      background: rgba(30, 30, 30, 0.95);
    }
    .accurate-panel.show {
      display: flex;
    }
    .accurate-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    body.dark .accurate-title {
      color: #fff;
    }
    .accurate-coordinates {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
      width: 100%;
      max-width: 600px;
    }
    .accurate-coordinate-set {
      display: flex;
      gap: 20px;
      justify-content: space-between;
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    body.dark .accurate-coordinate-set {
      background: #333;
    }
    .accurate-coordinate-set:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    body.dark .accurate-coordinate-set:hover {
      box-shadow: 0 4px 12px rgba(255,255,255,0.1);
    }
    .accurate-info-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .accurate-info-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
    }
    body.dark .accurate-info-label {
      color: #aaa;
    }
    .accurate-info-value {
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }
    body.dark .accurate-info-value {
      color: #fff;
    }
    .accurate-back-button {
      background: #000;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-transform: uppercase;
      margin-top: 20px;
    }
    body.dark .accurate-back-button {
      background: #333;
    }
    .accurate-close-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #333;
      cursor: pointer;
    }
    body.dark .accurate-close-button {
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="loading-indicator" id="loadingIndicator">
    <div class="spinner"></div>
  </div>
  <div class="top-bar">
    <label for="fileInput" class="add-button">
      <i class="bi bi-plus"></i>
    </label>
    <input type="file" id="fileInput" class="file-input" accept="image/*" />
    <button class="menu-button" id="themeButton" title="Theme">
      <i class="bi bi-sun"></i>
    </button>
    <button class="accurate-button" id="accurateButton" title="Top Accurate">
      <i class="bi bi-geo-alt"></i>
    </button>
    <button class="menu-button" title="Settings">
      <i class="bi bi-gear"></i>
    </button>
  </div>
  <div id="map"></div>
  <div id="streetviewContainer">
    <iframe id="streetviewIframe" src=""></iframe>
  </div>
  <div class="info-panel" id="infoPanel">
    <div class="location-preview">
      <div class="location-image">
        <img id="previewImage" src="" alt="Location" />
      </div>
      <div class="location-info">
        <div class="location-info-item">
          <div class="location-info-label">CITY:</div>
          <div class="location-info-value" id="cityValue">(Unknown)</div>
        </div>
        <div class="location-info-item">
          <div class="location-info-label">COUNTRY:</div>
          <div class="location-info-value" id="countryValue">(Unknown)</div>
        </div>
      </div>
    </div>
    <div class="location-coordinates">
      <div class="location-info-item">
        <div class="location-info-label">LATITUDE:</div>
        <div class="location-info-value" id="latValue">0</div>
      </div>
      <div class="location-info-item">
        <div class="location-info-label">LONGITUDE:</div>
        <div class="location-info-value" id="lngValue">0</div>
      </div>
    </div>
    <div>
      <div class="location-explanation-label">EXPLANATION:</div>
      <div class="location-explanation" id="explanationValue">
        (Explanation will appear here)
      </div>
    </div>
    <div class="button-container">
      <button class="maps-button" id="mapsButton">
        MAPS
      </button>
      <button class="street-view-button" id="streetViewButton">
        STREET VIEW
      </button>
    </div>
    <button class="export-button" id="exportButton">
      EXPORT PDF
    </button>
  </div>
  <div class="accurate-panel" id="accuratePanel">
    <button class="accurate-close-button" id="accurateCloseButton">X</button>
    <div class="accurate-title">Top Accurate Coordinates</div>
    <div class="accurate-coordinates">
      <div class="accurate-coordinate-set" data-index="0">
        <div class="accurate-info-item">
          <div class="accurate-info-label">LATITUDE 1</div>
          <div class="accurate-info-value" id="accurateLatValue1">0</div>
        </div>
        <div class="accurate-info-item">
          <div class="accurate-info-label">LONGITUDE 1</div>
          <div class="accurate-info-value" id="accurateLngValue1">0</div>
        </div>
      </div>
      <div class="accurate-coordinate-set" data-index="1">
        <div class="accurate-info-item">
          <div class="accurate-info-label">LATITUDE 2</div>
          <div class="accurate-info-value" id="accurateLatValue2">0</div>
        </div>
        <div class="accurate-info-item">
          <div class="accurate-info-label">LONGITUDE 2</div>
          <div class="accurate-info-value" id="accurateLngValue2">0</div>
        </div>
      </div>
      <div class="accurate-coordinate-set" data-index="2">
        <div class="accurate-info-item">
          <div class="accurate-info-label">LATITUDE 3</div>
          <div class="accurate-info-value" id="accurateLatValue3">0</div>
        </div>
        <div class="accurate-info-item">
          <div class="accurate-info-label">LONGITUDE 3</div>
          <div class="accurate-info-value" id="accurateLngValue3">0</div>
        </div>
      </div>
    </div>
    <button class="accurate-back-button" id="accurateBackButton">Back to Map</button>
  </div>
  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoiYXZpb3BvcnRvbGFubyIsImEiOiJja212cmRrd2QwN3dzMnZuMXV2d25xbWsxIn0.x3y36v9arY9wmBOCZlCXUA";
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: [-81.7800, 24.5551],
      zoom: 1,
    });
    let markersArray = [];
    let currentImage = null;
    let selectedMarker = null;
    let lastMatchedCoord = null;
    let topAccurateCoords = [
      { lat: 0, lng: 0 },
      { lat: 0, lng: 0 },
      { lat: 0, lng: 0 }
    ];
    const fileInput = document.getElementById("fileInput");
    const infoPanel = document.getElementById("infoPanel");
    const mapsButton = document.getElementById("mapsButton");
    const streetViewButton = document.getElementById("streetViewButton");
    const previewImage = document.getElementById("previewImage");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const streetviewContainer = document.getElementById("streetviewContainer");
    const streetviewIframe = document.getElementById("streetviewIframe");
    const themeButton = document.getElementById("themeButton");
    const accurateButton = document.getElementById("accurateButton");
    const accuratePanel = document.getElementById("accuratePanel");
    const accurateBackButton = document.getElementById("accurateBackButton");
    const accurateCloseButton = document.getElementById("accurateCloseButton");
    const accurateLatValue1 = document.getElementById("accurateLatValue1");
    const accurateLngValue1 = document.getElementById("accurateLngValue1");
    const accurateLatValue2 = document.getElementById("accurateLatValue2");
    const accurateLngValue2 = document.getElementById("accurateLngValue2");
    const accurateLatValue3 = document.getElementById("accurateLatValue3");
    const accurateLngValue3 = document.getElementById("accurateLngValue3");

    // Theme toggle functionality
    let isDarkTheme = false;
    themeButton.addEventListener("click", () => {
      isDarkTheme = !isDarkTheme;
      document.body.classList.toggle("dark");
      themeButton.innerHTML = `<i class="bi ${isDarkTheme ? 'bi-sun' : 'bi-moon'}"></i>`;
      map.setStyle(`mapbox://styles/mapbox/${isDarkTheme ? 'dark-v10' : 'streets-v11'}`);
      localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
    });

    // Load saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      isDarkTheme = true;
      document.body.classList.add("dark");
      themeButton.innerHTML = `<i class="bi bi-sun"></i>`;
      map.setStyle("mapbox://styles/mapbox/dark-v10");
    }

    // Function to save data to localStorage
    function saveLocationData(imageUrl, lng, lat, explanation) {
      const locationData = {
        imageUrl: imageUrl,
        longitude: lng,
        latitude: lat,
        explanation: explanation
      };
      localStorage.setItem('locationData', JSON.stringify(locationData));
    }

    // Function to load data from localStorage
    function loadLocationData() {
      const savedData = localStorage.getItem('locationData');
      return savedData ? JSON.parse(savedData) : null;
    }

    function compressImage(imageUrl, callback) {
      const img = new Image();
      img.onload = function() {
        const maxWidth = 800;
        const maxHeight = 600;
        let width = img.width;
        let height = img.height;
        if (width > maxWidth) {
          height = height * (maxWidth / width);
          width = maxWidth;
        }
        if (height > maxHeight) {
          width = width * (maxHeight / height);
          height = maxHeight;
        }
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        const compressedDataUrl = canvas.toDataURL("image/jpeg", 0.6);
        callback(compressedDataUrl);
      };
      img.src = imageUrl;
    }

    function updateLocationInfo(lng, lat, imageUrl) {
      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}`)
        .then((res) => res.json())
        .then((data) => {
          const cityFeature = data.features.find((f) => f.place_type.includes("place"));
          const countryFeature = data.features.find((f) => f.place_type.includes("country"));
          const city = cityFeature ? cityFeature.text : "(Unknown)";
          const country = countryFeature ? countryFeature.text : "(Unknown)";
          let explanation = "";
          if (data.features.length > 0) {
            const feature = data.features[0];
            explanation = feature.place_name || "Location details not available.";
          } else {
            explanation = "No specific location details available.";
          }
          document.getElementById("countryValue").textContent = country.toUpperCase();
          document.getElementById("cityValue").textContent = city.toUpperCase();
          document.getElementById("latValue").textContent = lat.toFixed(4);
          document.getElementById("lngValue").textContent = lng.toFixed(4);
          document.getElementById("explanationValue").textContent = explanation;
          if (imageUrl) {
            previewImage.src = imageUrl;
          }
        })
        .catch((err) => {
          console.error("Geocoding error:", err);
          document.getElementById("explanationValue").textContent = "Error retrieving location details.";
        });
    }

    function updateAccuratePanel(coords) {
      accurateLatValue1.textContent = coords[0].lat.toFixed(4);
      accurateLngValue1.textContent = coords[0].lng.toFixed(4);
      accurateLatValue2.textContent = coords[1].lat.toFixed(4);
      accurateLngValue2.textContent = coords[1].lng.toFixed(4);
      accurateLatValue3.textContent = coords[2].lat.toFixed(4);
      accurateLngValue3.textContent = coords[2].lng.toFixed(4);
    }

    accurateButton.addEventListener("click", () => {
      if (lastMatchedCoord) {
        topAccurateCoords = [
          { lat: lastMatchedCoord.lat, lng: lastMatchedCoord.lng },
          { lat: lastMatchedCoord.lat + 0.001, lng: lastMatchedCoord.lng + 0.001 },
          { lat: lastMatchedCoord.lat - 0.001, lng: lastMatchedCoord.lng - 0.001 }
        ];
        updateAccuratePanel(topAccurateCoords);
        accuratePanel.classList.add("show");
        map.getContainer().style.display = 'none';
        document.querySelector('.top-bar').style.display = 'none';
        infoPanel.classList.remove("show");
      } else {
        alert("No location data available for Top Accurate view.");
      }
    });

    accurateBackButton.addEventListener("click", () => {
      accuratePanel.classList.remove("show");
      map.getContainer().style.display = 'block';
      document.querySelector('.top-bar').style.display = 'flex';
      if (lastMatchedCoord) {
        map.flyTo({ center: [lastMatchedCoord.lng, lastMatchedCoord.lat], zoom: 14 });
      }
    });

    accurateCloseButton.addEventListener("click", () => {
      accuratePanel.classList.remove("show");
      map.getContainer().style.display = 'block';
      document.querySelector('.top-bar').style.display = 'flex';
      if (lastMatchedCoord) {
        map.flyTo({ center: [lastMatchedCoord.lng, lastMatchedCoord.lat], zoom: 14 });
      }
    });

    document.querySelectorAll('.accurate-coordinate-set').forEach((set, index) => {
      set.addEventListener('click', () => {
        const coords = topAccurateCoords[index];
        if (coords) {
          accuratePanel.classList.remove("show");
          map.getContainer().style.display = 'block';
          document.querySelector('.top-bar').style.display = 'flex';
          map.flyTo({ center: [coords.lng, coords.lat], zoom: 14 });
          lastMatchedCoord = coords;
          updateLocationInfo(coords.lng, coords.lat, currentImage);
          infoPanel.classList.add("show");
          const markerPosition = map.project([coords.lng, coords.lat]);
          infoPanel.style.position = 'absolute';
          infoPanel.style.left = `${markerPosition.x + 20}px`;
          infoPanel.style.top = `${markerPosition.y}px`;
        }
      });
    });

    fileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      loadingIndicator.classList.add('show');
      try {
        const formData = new FormData();
        formData.append('photo', file);
        const response = await fetch('/predict', {
          method: 'POST',
          body: formData
        });
        let latitude, longitude;
        if (!response.ok) {
          console.warn(`HTTP error! Status: ${response.status}, using example coordinates.`);
          latitude = 40.7128;
          longitude = -74.0060;
        } else {
          const result = await response.json();
          if (result.error) {
            console.warn(`Prediction error: ${result.error}, using example coordinates.`);
            latitude = 40.7128;
            longitude = -74.0060;
          } else {
            latitude = result.latitude;
            longitude = result.longitude;
          }
        }
        lastMatchedCoord = { lat: latitude, lng: longitude };
        loadingIndicator.classList.remove('show');
        compressImage(URL.createObjectURL(file), function(compressedDataUrl) {
          currentImage = compressedDataUrl;
          localStorage.removeItem('locationData');
          saveLocationData(currentImage, longitude, latitude, "");
          if (selectedMarker) {
            selectedMarker.remove();
            markersArray = markersArray.filter(marker => marker !== selectedMarker);
            selectedMarker = null;
          }
          map.flyTo({ center: [longitude, latitude], zoom: 14 });
          const markerElement = document.createElement("div");
          markerElement.className = "location-marker";
          const markerImg = document.createElement("img");
          markerImg.src = currentImage;
          markerElement.appendChild(markerImg);
          selectedMarker = new mapboxgl.Marker({
            element: markerElement,
            draggable: false,
          })
            .setLngLat([longitude, latitude])
            .addTo(map);
          markersArray.push(selectedMarker);
          const markerPosition = map.project([longitude, latitude]);
          infoPanel.style.position = 'absolute';
          infoPanel.style.left = `${markerPosition.x + 20}px`;
          infoPanel.style.top = `${markerPosition.y}px`;
          infoPanel.classList.add("show");
          markerElement.addEventListener("click", (ev) => {
            ev.stopPropagation();
            const savedData = loadLocationData();
            if (savedData) {
              updateLocationInfo(savedData.longitude, savedData.latitude, savedData.imageUrl);
            }
            infoPanel.classList.add("show");
          });
          updateLocationInfo(longitude, latitude, currentImage);
          currentImage = null;
        });
      } catch (error) {
        loadingIndicator.classList.remove('show');
        console.error('Error:', error);
        const latitude = 40.7128;
        const longitude = -74.0060;
        lastMatchedCoord = { lat: latitude, lng: longitude };
        compressImage(URL.createObjectURL(file), function(compressedDataUrl) {
          currentImage = compressedDataUrl;
          localStorage.removeItem('locationData');
          saveLocationData(currentImage, longitude, latitude, "");
          if (selectedMarker) {
            selectedMarker.remove();
            markersArray = markersArray.filter(marker => marker !== selectedMarker);
            selectedMarker = null;
          }
          map.flyTo({ center: [longitude, latitude], zoom: 14 });
          const markerElement = document.createElement("div");
          markerElement.className = "location-marker";
          const markerImg = document.createElement("img");
          markerImg.src = currentImage;
          markerElement.appendChild(markerImg);
          selectedMarker = new mapboxgl.Marker({
            element: markerElement,
            draggable: false,
          })
            .setLngLat([longitude, latitude])
            .addTo(map);
          markersArray.push(selectedMarker);
          const markerPosition = map.project([longitude, latitude]);
          infoPanel.style.position = 'absolute';
          infoPanel.style.left = `${markerPosition.x + 20}px`;
          infoPanel.style.top = `${markerPosition.y}px`;
          infoPanel.classList.add("show");
          markerElement.addEventListener("click", (ev) => {
            ev.stopPropagation();
            const savedData = loadLocationData();
            if (savedData) {
              updateLocationInfo(savedData.longitude, savedData.latitude, savedData.imageUrl);
            }
            infoPanel.classList.add("show");
          });
          updateLocationInfo(longitude, latitude, currentImage);
          currentImage = null;
        });
      }
    });

    mapsButton.addEventListener("click", () => {
      streetviewContainer.style.display = 'none';
      map.getContainer().style.display = 'block';
      infoPanel.classList.remove("show");
    });

    streetViewButton.addEventListener('click', () => {
      if (lastMatchedCoord) {
        const lat = lastMatchedCoord.lat;
        const lng = lastMatchedCoord.lng;
        const streetViewUrl = `https://www.google.com/maps/embed?pb=!4v0!6m8!1m7!1sCAoSLEFGMVFpcE1pVUlONllYeHpHdXVpUjd4cjlHcWxGQVZ2cnlyT1I5NmFwTE9B!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469`;
        streetviewIframe.src = streetViewUrl;
        streetviewContainer.style.display = 'block';
        map.getContainer().style.display = 'none';
        document.querySelector('.top-bar').style.display = 'flex';
      } else {
        alert("No location selected for Street View.");
      }
    });

    map.on('move', () => {
      if (selectedMarker && lastMatchedCoord) {
        const markerPosition = map.project([lastMatchedCoord.lng, lastMatchedCoord.lat]);
        infoPanel.style.left = `${markerPosition.x + 20}px`;
        infoPanel.style.top = `${markerPosition.y}px`;
        selectedMarker.setLngLat([lastMatchedCoord.lng, lastMatchedCoord.lat]);
        selectedMarker.getElement().style.transform = 'translate(-50%, -100%)';
        infoPanel.style.transform = 'none';
      }
    });

    map.on("click", function(e) {
      if (!currentImage) {
        infoPanel.classList.remove("show");
        document.getElementById("countryValue").textContent = "(Unknown)";
        document.getElementById("cityValue").textContent = "(Unknown)";
        document.getElementById("latValue").textContent = "0";
        document.getElementById("lngValue").textContent = "0";
        document.getElementById("explanationValue").textContent = "(Explanation will appear here)";
        previewImage.src = "";
      }
    });
  </script>
</body>
</html>
