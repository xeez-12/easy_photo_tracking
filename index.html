<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Geolocation SPY</title>
  <!-- Mapbox GL JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- EXIF JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    body {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
    }
    #app-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #streetview-container {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 20;
    }
    #streetview {
      width: 100%;
      height: 100%;
      border: none;
    }
    #info-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 300px;
      background-color: rgba(18,18,18,0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
    }
    #search-container {
      display: flex;
      align-items: center;
      background-color: #242424;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 20px;
    }
    #search-container svg {
      margin-right: 8px;
      opacity: 0.7;
    }
    #search-input {
      background: none;
      border: none;
      color: #fff;
      outline: none;
      width: 100%;
      font-size: 14px;
    }
    #image-preview {
      width: 100%;
      aspect-ratio: 1/1;
      background-color: #242424;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }
    #image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(36,36,36,0.8);
      cursor: pointer;
    }
    #upload-overlay.hidden {
      display: none;
    }
    #upload-icon {
      margin-bottom: 10px;
      opacity: 0.7;
    }
    #upload-text {
      color: #fff;
      font-size: 14px;
      text-align: center;
    }
    .location-info {
      margin-bottom: 15px;
    }
    .location-label {
      color: #999;
      font-size: 12px;
      margin-bottom: 3px;
    }
    .location-value {
      color: #fff;
      font-size: 14px;
      margin-bottom: 10px;
      font-weight: 500;
    }
    #action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }
    .action-btn {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #242424;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .action-btn:hover {
      background-color: #333;
    }
    .enterprise-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(0,0,0,0.5);
      border-radius: 4px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      z-index: 200;
    }
    .enterprise-text {
      margin-right: 10px;
    }
    .enterprise-badge .title {
      font-size: 14px;
      font-weight: 500;
    }
    .enterprise-badge .subtitle {
      font-size: 12px;
      color: #ccc;
    }
    .badge-link {
      display: flex;
      align-items: center;
      color: white;
      text-decoration: none;
    }
    .floating-info {
      position: absolute;
      background-color: rgba(0,0,0,0.7);
      border-radius: 6px;
      padding: 10px 12px;
      z-index: 200;
      color: white;
      font-size: 13px;
    }
    #location-name {
      top: 20px;
      left: 340px;
    }
    #location-name .title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    #location-name .subtitle {
      display: none;
    }
    #lens-box {
      position: absolute;
      top: 20px;
      left: 480px;
      background-color: rgba(0,0,0,0.7);
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      z-index: 200;
    }
    #lens-box:hover {
      background-color: rgba(0,0,0,0.9);
    }
    #lens-icon {
      width: 18px;
      height: 18px;
      color: white;
      opacity: 0.9;
    }
    #neighborhood-info {
      position: absolute;
      bottom: 30px;
      left: 20px;
      background-color: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #ccc;
      z-index: 999;
    }
    .attribution {
      display: none;
    }
    .mapboxgl-canvas {
      outline: none;
    }
    .mapboxgl-ctrl-logo {
      display: none !important;
    }
    #file-input {
      display: none;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    /* Enhanced Lens Popup Styles */
    #lens-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1500;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #lens-popup-content {
      background-color: #1c1c1c;
      border-radius: 16px;
      padding: 25px;
      max-width: 900px;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #lens-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #3a3a3a;
    }
    #lens-popup-title {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
    }
    #lens-close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background-color 0.2s;
    }
    #lens-close-btn:hover {
      background-color: rgba(255,255,255,0.15);
    }
    #lens-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }
    .lens-result-item {
      background-color: #282828;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .lens-result-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .lens-result-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
      transition: opacity 0.2s;
    }
    .lens-result-image:hover {
      opacity: 0.9;
    }
    .lens-result-info {
      padding: 15px;
    }
    .lens-result-title {
      font-size: 14px;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .lens-result-source {
      font-size: 12px;
      color: #aaa;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    #lens-loading {
      text-align: center;
      padding: 50px;
      color: #ddd;
      font-size: 16px;
    }
    #lens-error {
      text-align: center;
      padding: 50px;
      color: #ff5555;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="map"></div>
    <div id="streetview-container">
      <iframe id="streetview"></iframe>
    </div>
    <div id="info-panel">
      <div id="search-container">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="search-input" placeholder="New search" />
      </div>
      <div id="image-preview">
        <img id="preview-img" src="" style="display: none;" />
        <div id="upload-overlay">
          <svg id="upload-icon" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <p id="upload-text">Click to upload an image</p>
        </div>
      </div>
      <div class="location-info">
        <div class="location-label">Detail</div>
        <div class="location-value" id="detail-value">unknown</div>
        <div class="location-label">Negara</div>
        <div class="location-value" id="country-value">unknown</div>
        <div class="location-label">Kota</div>
        <div class="location-value" id="city-value">unknown</div>
        <div class="location-label">Kordinator</div>
        <div class="location-value" id="coord-value">unknown</div>
      </div>
      <div id="action-buttons">
        <div class="action-btn" id="map-btn">Map</div>
        <div class="action-btn" id="share-geospy">Street View</div>
      </div>
    </div>
    <div class="enterprise-badge">
      <div class="enterprise-text">
        <div class="title">Enterprise?</div>
        <div class="subtitle">Partner with us</div>
      </div>
      <a href="#" class="badge-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </a>
    </div>
    <div class="floating-info" id="location-name">
      <div class="title">Geolocation SPY</div>
    </div>
    <div id="lens-box">
      <svg id="lens-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 8v6"></path>
        <path d="m1 12 6 0m8 0 6 0"></path>
        <path d="m4.93 4.93 4.24 4.24m5.66 5.66 4.24 4.24"></path>
        <path d="m19.07 4.93-4.24 4.24m-5.66 5.66-4.24 4.24"></path>
      </svg>
    </div>
    <div id="neighborhood-info">sweet geolocation</div>
  </div>
  
  <!-- Enhanced Lens Popup -->
  <div id="lens-popup">
    <div id="lens-popup-content">
      <div id="lens-popup-header">
        <div id="lens-popup-title">Similar Images</div>
        <button id="lens-close-btn">Ã—</button>
      </div>
      <div id="lens-loading" style="display: none;">
        <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
        <p>Searching for similar images...</p>
      </div>
      <div id="lens-error" style="display: none;">
        <p>Failed to load similar images</p>
      </div>
      <div id="lens-results"></div>
    </div>
  </div>

  <input type="file" id="file-input" accept="image/*" />
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <script>
    const MAPBOX_TOKEN = "pk.eyJ1IjoiYXZpb3BvcnRvbGFubyIsImEiOiJja212cmRrd2QwN3dzMnZuMXV2d25xbWsxIn0.x3y36v9arY9wmBOCZlCXUA";
    const GEMINI_API_KEY = "AIzaSyBnAFtB1TcTzpkJ1CwxgjSurhhUSVOo9HI"; // Replace with your Gemini API key

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/dark-v10",
      center: [0, 0],
      zoom: 2,
      pitch: 0,
    });

    let trackingMarker = null;
    let lastMatchedCoord = { lat: 0, lng: 0 };
    let currentImageBase64 = null;

    const fileInput = document.getElementById("file-input");
    const previewImg = document.getElementById("preview-img");
    const uploadOverlay = document.getElementById("upload-overlay");
    const loadingOverlay = document.getElementById("loading-overlay");
    const lensPopup = document.getElementById("lens-popup");
    const lensCloseBtn = document.getElementById("lens-close-btn");
    const lensLoading = document.getElementById("lens-loading");
    const lensError = document.getElementById("lens-error");
    const lensResults = document.getElementById("lens-results");

    function imageToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function searchSimilarImages(imageBase64) {
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: `Perform a reverse image search for this image to find visually similar images on the web. Return a list of at least 6 similar images with their titles, source URLs, thumbnail URLs, and brief descriptions. Ensure the results are relevant and exclude any copyrighted or restricted content. Format the response as JSON with the following structure:
                      [
                        {
                          "title": "string",
                          "thumbnail": "string",
                          "source": "string",
                          "link": "string",
                          "description": "string"
                        }
                      ]`
                    },
                    {
                      inlineData: {
                        mimeType: "image/jpeg",
                        data: imageBase64,
                      },
                    },
                  ],
                },
              ],
            }),
          }
        );

        if (!response.ok) {
          throw new Error(`Gemini API error: ${response.statusText}`);
        }

        const data = await response.json();
        let resultText = data.candidates[0].content.parts[0].text;

        // Clean Markdown code blocks
        resultText = resultText.replace(/```json\n|\n```/g, '').trim();

        // Parse the cleaned JSON
        let similarImages;
        try {
          similarImages = JSON.parse(resultText);
        } catch (parseError) {
          console.error("Failed to parse Gemini similar images response:", parseError);
          throw new Error("Invalid JSON response from Gemini API");
        }

        // Filter out invalid entries
        return similarImages.filter(img => 
          img.title && img.thumbnail && img.source && img.link && img.description
        ).slice(0, 6); // Limit to 6 results
      } catch (error) {
        console.error('Error searching similar images with Gemini:', error);
        
        // Fallback demo results
        return [
          {
            title: "Similar Location Demo 1",
            thumbnail: "https://picsum.photos/300/200?random=1",
            source: "Demo Source",
            link: "#",
            description: "A sample image for demonstration purposes."
          },
          {
            title: "Similar Location Demo 2",
            thumbnail: "https://picsum.photos/300/200?random=2",
            source: "Demo Source",
            link: "#",
            description: "Another sample image for demonstration."
          },
          {
            title: "Similar Location Demo 3",
            thumbnail: "https://picsum.photos/300/200?random=3",
            source: "Demo Source",
            link: "#",
            description: "Third sample image for demonstration."
          },
          {
            title: "Similar Location Demo 4",
            thumbnail: "https://picsum.photos/300/200?random=4",
            source: "Demo Source",
            link: "#",
            description: "Fourth sample image for demonstration."
          },
          {
            title: "Similar Location Demo 5",
            thumbnail: "https://picsum.photos/300/200?random=5",
            source: "Demo Source",
            link: "#",
            description: "Fifth sample image for demonstration."
          },
          {
            title: "Similar Location Demo 6",
            thumbnail: "https://picsum.photos/300/200?random=6",
            source: "Demo Source",
            link: "#",
            description: "Sixth sample image for demonstration."
          }
        ];
      }
    }

    async function analyzePhotoWithGemini(photoBlob) {
      try {
        const base64Image = await imageToBase64(photoBlob);
        currentImageBase64 = base64Image;
        
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: `Analyze this image in detail to determine its precise geographic location. Extract any visible landmarks, street signs, architectural styles, or other identifiable features. If possible, cross-reference these with known locations to provide accurate coordinates. Return the response in JSON format with the following fields:
                      {
                        "latitude": number,
                        "longitude": number,
                        "city": "string",
                        "country": "string",
                        "description": "string",
                        "confidence": number (0 to 1 indicating confidence in the location)
                      }
                      If the location cannot be determined, provide estimated coordinates based on visual cues and set a lower confidence score. Include a detailed description of the analysis process.`
                    },
                    {
                      inlineData: {
                        mimeType: photoBlob.type,
                        data: base64Image,
                      },
                    },
                  ],
                },
              ],
            }),
          }
        );

        if (!response.ok) {
          throw new Error(`Gemini API error: ${response.statusText}`);
        }

        const data = await response.json();
        let resultText = data.candidates[0].content.parts[0].text;

        // Clean Markdown code blocks
        resultText = resultText.replace(/```json\n|\n```/g, '').trim();

        // Parse the cleaned JSON
        let locationData;
        try {
          locationData = JSON.parse(resultText);
        } catch (parseError) {
          console.error("Failed to parse Gemini response as JSON:", parseError);
          throw new Error("Invalid JSON response from Gemini API");
        }

        // Validate required fields
        if (!locationData.latitude || !locationData.longitude) {
          throw new Error("Missing latitude or longitude in Gemini response");
        }

        return {
          lat: parseFloat(locationData.latitude) || 0,
          lng: parseFloat(locationData.longitude) || 0,
          city: locationData.city || "unknown",
          country: locationData.country || "unknown",
          description: locationData.description || "unknown",
          confidence: locationData.confidence || 0.5
        };
      } catch (error) {
        console.error("Error analyzing photo with Gemini:", error);
        alert("Failed to analyze image with Gemini API. Using default location.");
        return {
          lat: 0,
          lng: 0,
          city: "unknown",
          country: "unknown",
          description: "unknown",
          confidence: 0
        };
      }
    }

    async function reverseGeocode(lat, lng) {
      try {
        const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}`;
        const res = await fetch(endpoint);
        const data = await res.json();
        let detail = "unknown", country = "unknown", city = "unknown";
        if (data.features && data.features.length > 0) {
          detail = data.features[0].place_name || "unknown";
          data.features.forEach(f => {
            if (f.place_type.includes("country")) country = f.text;
            if (f.place_type.includes("place")) city = f.text;
          });
        }
        return { detail, country, city };
      } catch (error) {
        console.error("Error in reverse geocoding:", error);
        return { detail: "unknown", country: "unknown", city: "unknown" };
      }
    }

    function displaySimilarImages(images) {
      lensResults.innerHTML = '';
      
      images.forEach(image => {
        const item = document.createElement('div');
        item.className = 'lens-result-item';
        
        const img = document.createElement('img');
        img.className = 'lens-result-image';
        img.src = image.thumbnail || '';
        img.alt = image.title || 'Similar image';
        
        const info = document.createElement('div');
        info.className = 'lens-result-info';
        
        const title = document.createElement('div');
        title.className = 'lens-result-title';
        title.textContent = image.title || 'Unknown';
        
        const source = document.createElement('div');
        source.className = 'lens-result-source';
        source.textContent = image.source || 'Unknown source';
        
        info.appendChild(title);
        info.appendChild(source);
        item.appendChild(img);
        item.appendChild(info);
        
        item.addEventListener('click', () => {
          if (image.link) {
            window.open(image.link, '_blank');
          }
        });
        
        lensResults.appendChild(item);
      });
    }

    // Enhanced Lens functionality
    document.getElementById("lens-box").addEventListener('click', async () => {
      if (!currentImageBase64) {
        alert('Please upload an image first');
        return;
      }
      
      lensPopup.style.display = 'flex';
      lensLoading.style.display = 'block';
      lensError.style.display = 'none';
      lensResults.innerHTML = '';
      
      try {
        const similarImages = await searchSimilarImages(currentImageBase64);
        lensLoading.style.display = 'none';
        
        if (similarImages.length > 0) {
          displaySimilarImages(similarImages);
        } else {
          lensError.style.display = 'block';
          document.getElementById('lens-error').innerHTML = '<p>No similar images found</p>';
        }
      } catch (error) {
        lensLoading.style.display = 'none';
        lensError.style.display = 'block';
        document.getElementById('lens-error').innerHTML = '<p>Error loading similar images. Showing demo results.</p>';
        
        // Show demo results
        const demoImages = [
          {
            title: "Demo Image 1",
            thumbnail: "https://picsum.photos/300/200?random=10",
            source: "Demo Source",
            link: "#",
            description: "Sample demo image."
          },
          {
            title: "Demo Image 2",
            thumbnail: "https://picsum.photos/300/200?random=11",
            source: "Demo Source",
            link: "#",
            description: "Another sample demo image."
          }
        ];
        displaySimilarImages(demoImages);
      }
    });

    lensCloseBtn.addEventListener('click', () => {
      lensPopup.style.display = 'none';
    });

    lensPopup.addEventListener('click', (e) => {
      if (e.target === lensPopup) {
        lensPopup.style.display = 'none';
      }
    });

    document.getElementById("image-preview").addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      loadingOverlay.style.display = "flex";

      const reader = new FileReader();
      reader.onload = async (evt) => {
        const imageData = evt.target.result;
        previewImg.src = imageData;
        previewImg.style.display = "block";
        uploadOverlay.classList.add("hidden");

        const locationData = await analyzePhotoWithGemini(file);
        lastMatchedCoord = { lat: locationData.lat, lng: locationData.lng };

        let info = {
          detail: locationData.description,
          country: locationData.country,
          city: locationData.city,
        };

        if (info.detail === "unknown" || info.country === "unknown" || info.city === "unknown") {
          const geocodedInfo = await reverseGeocode(locationData.lat, locationData.lng);
          info = {
            detail: info.detail !== "unknown" ? info.detail : geocodedInfo.detail,
            country: info.country !== "unknown" ? info.country : geocodedInfo.country,
            city: info.city !== "unknown" ? info.city : geocodedInfo.city,
          };
        }

        document.getElementById("detail-value").textContent = info.detail;
        document.getElementById("country-value").textContent = info.country;
        document.getElementById("city-value").textContent = info.city;
        document.getElementById("coord-value").textContent =
          locationData.lat.toFixed(5) + ", " + locationData.lng.toFixed(5);

        if (trackingMarker) trackingMarker.remove();
        const markerEl = document.createElement("img");
        markerEl.src = imageData;
        markerEl.style.width = "60px";
        markerEl.style.height = "60px";
        markerEl.style.borderRadius = "50%";
        markerEl.style.border = "2px solid white";
        trackingMarker = new mapboxgl.Marker(markerEl)
          .setLngLat([locationData.lng, locationData.lat])
          .addTo(map);
        map.flyTo({
          center: [locationData.lng, locationData.lat],
          zoom: 14,
          essential: true,
        });

        loadingOverlay.style.display = "none";
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("map-btn").addEventListener("click", () => {
      document.getElementById("streetview-container").style.display = "none";
      document.getElementById("map").style.display = "block";
    });

    document.getElementById("share-geospy").addEventListener("click", () => {
      const lat = lastMatchedCoord.lat;
      const lng = lastMatchedCoord.lng;
      const streetViewUrl = `https://www.google.com/maps/embed?pb=!4v0!6m8!1m7!1sCAoSLEFGMVFpcE1pVUlONllYeXpHdXVpUjd4cjlHcWxGQVZ2cnlyT1I5NmFwTE9B!2m2!1d${lat}!2d${lng}!3f0!4f0!5f0.7820865974627469`;
      document.getElementById("streetview").src = streetViewUrl;
      document.getElementById("streetview-container").style.display = "block";
      document.getElementById("map").style.display = "none";
    });

    document.querySelector(".badge-link").addEventListener("click", () => {
      alert("Enterprise link clicked!");
    });
  </script>
</body>
</html>
